<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <link media="screen" rel="stylesheet" href="/styles.css">
  <script type="module" src="/runtime.js"></script>
  <title>Restroom Place</title>
  <style media="screen">
    header {
      width: 100%;
    }

    header>div {
      display: flex;
      align-items: center;
    }

    header>div>p {
      flex: 1;
      text-align: left;
      font-style: italic;
    }

    header .profile-picture {
      margin-right: 8px;
    }

    main {
      flex: 1;
      width: 100%;
      margin: 16px 0;
    }

    article.placeholder {
      font-size: 14px;
    }

    aside {
      width: 100%;
      margin-bottom: 12px;
    }

    aside form {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    aside form>textarea {
      flex: 1;
    }

    aside form textarea {
      width: 100%;
      height: 100%;
    }

    aside form>div {
      align-self: flex-end;
    }

    aside button {
      font-size: 16px;
      display: block;
    }
  </style>
</head>

<body class="center-flex">
  <header class="hidden" aria-hidden="true">
    <h1></h1>
    <div>
      <img class="profile-picture" src="#" title="Profile picture" height="100">
      <p></p>
    </div>
  </header>
  <main>
  </main>
  <aside>
    <form method="POST" id="post" class="hidden" aria-hidden="true">
      <textarea placeholder="Vaše zpráva?" required></textarea>
      <div>
        <button type="submit">Odeslat</button>
        <p class="disclaimer">anonymně</p>
      </div>
    </form>
  </aside>
  <script type="module">
    import { parseRoomIdFromUrl } from "/library.js";
    import { getDocData } from "/firestore.js"
    import { isCurrentUserVerified } from "/authentication.js";
    import { getRoomProfilePictureUrl } from "/storage.js";

    const roomId = parseRoomIdFromUrl();
    const profile = await getDocData(`rooms/${roomId}/public/profile`).catch(console.error);

    if (!profile) {
      alert("Místnost neexistuje, ale můžete ji vytvořit.")
      window.location.href = roomId ? '/room/generate' : `/room/generate?roomId=${roomId}`;
    }

    if (!profile.initialized) {
      document.querySelector("header").innerHTML = `
        <h1>Místnost zatím není inicializována.</h1>
      `;
      document.querySelector("main").innerHTML = `
        <a id="manage-room" class="button" href="/room/${roomId}/manage">Spravovat místnost</a>
        <p class="disclaimer">Získáte moc nad tímto místem.</p>
      `;
      document.querySelector("header").classList.remove("hidden")
      document.querySelector("header").setAttribute('aria-hidden', false);
      document.querySelector('#manage-room').addEventListener('click', event => {
        if (!isCurrentUserVerified()) {
          event.preventDefault();
          alert('Pro správu místnosti musíte být ověřený.');
          const destination = encodeURIComponent((new URL(event.target.href)).pathname);
          window.location.href = `/verify-self/?destination=${destination}`;
        }
      })
    } else {
      const postForm = document.querySelector("#post");
      postForm.classList.remove("hidden");
      postForm.setAttribute('aria-hidden', false);
    }

    if (profile.initialized) {
      document.querySelector("header h1").innerText = profile.name || '';
      document.querySelector("header p").innerText = profile.bio || '';
      document.querySelector("header img").src = await getRoomProfilePictureUrl(roomId);

      document.querySelector("header").classList.remove("hidden")
      document.querySelector("header").setAttribute('aria-hidden', false);
    }

    document.querySelector('body header').addEventListener("click", () => {
      window.location.href = `/room/${roomId}/manage`;
    });


    // const posts = await getDocData(`rooms/${roomId}/public/posts`).catch(console.error) || [];
    const posts = [];

  </script>
</body>

</html>