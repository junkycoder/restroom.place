<!DOCTYPE html>
<html lang="cs">

<head>
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <link media="screen" rel="stylesheet" href="/styles.css">
  <script type="module" src="/runtime.js"></script>
  <title>Restroom Place</title>
  <style media="screen">
    header {
      width: 100%;
    }

    header>div {
      display: flex;
      align-items: center;
    }

    header>div>p {
      flex: 1;
      text-align: left;
      font-style: italic;
    }

    header .profile-picture {
      margin-right: 8px;
    }

    main {
      flex: 1;
      width: 100%;
      margin: 16px 0;
    }

    article.placeholder {
      font-size: 14px;
    }

    article {
      padding: 8px 0;
      border-top: 1px solid #eee;
      line-height: 1.2;
      font-size: 14px;
    }

    article:last-child {
      border-bottom: 1px solid #eee;
    }

    article pre {
      white-space: pre-wrap;
    }

    aside {
      width: 100%;
      margin-bottom: 12px;
    }

    aside form {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    aside form>textarea {
      flex: 1;
    }

    aside form textarea {
      width: 100%;
      height: 100%;
    }

    aside form>div {
      align-self: flex-end;
    }

    aside button {
      font-size: 16px;
      display: block;
    }
  </style>
</head>

<body class="center-flex">
  <header class="hidden" aria-hidden="true">
    <h1></h1>
    <div>
      <img class="profile-picture" src="#" title="Profile picture" height="100">
      <div id="bio"></div>
    </div>
  </header>
  <main>
  </main>
  <aside>
    <form method="POST" id="post" class="hidden" aria-hidden="true">
      <textarea placeholder="Vaše zpráva?" required name="text"></textarea>
      <div>
        <button type="submit">Odeslat</button>
        <p class="disclaimer">anonymně</p>
      </div>
    </form>
  </aside>
  <script type="module">
    import { parseRoomIdFromUrl } from "/library.js";
    import { getDocData, getCollectionData } from "/firestore.js"
    import { isCurrentUserVerified } from "/authentication.js";
    import { getRoomProfilePictureUrl } from "/storage.js";
    import { createPost } from "/functions.js";

    const roomId = parseRoomIdFromUrl();
    if (!roomId) window.location.href = "/";

    const postForm = document.querySelector("#post");
    const postSubmitButton = postForm.querySelector('button[type="submit"]');


    document.addEventListener("user-verified", handlePublicProfile);
    document.addEventListener("user-anonymous", handlePublicProfile);

    postForm.addEventListener("submit", handleFormSubmit);

    async function handlePublicProfile() {
      const profile = await getDocData(`rooms/${roomId}/public/profile`).catch(console.error);

      if (!profile) {
        alert("Místnost neexistuje, ale můžete ji vytvořit.")
        window.location.href = roomId ? '/room/generate' : `/room/generate?roomId=${roomId}`;
      }

      if (!profile.initialized) {
        document.querySelector("header").innerHTML = `
          <h1>Místnost zatím není inicializována.</h1>
        `;
        document.querySelector("main").innerHTML = `
          <a id="manage-room" class="button" href="/room/${roomId}/manage">Spravovat místnost</a>
          <p class="disclaimer">Získáte moc nad tímto místem.</p>
        `;
        document.querySelector("header").classList.remove("hidden")
        document.querySelector("header").setAttribute('aria-hidden', false);
        document.querySelector('#manage-room').addEventListener('click', event => {
          if (!isCurrentUserVerified()) {
            event.preventDefault();
            alert('Pro správu místnosti musíte být ověřený.');
            const destination = encodeURIComponent((new URL(event.target.href)).pathname);
            window.location.href = `/user/verify-self/?destination=${destination}`;
          }
        })
      } else {
        postForm.classList.remove("hidden");
        postForm.setAttribute('aria-hidden', false);
      }

      if (profile.initialized) {
        document.querySelector("header h1").innerText = profile.name || '';
        document.querySelector("#bio")[profile.html ? 'innerHTML' : 'innerText'] = profile.html || profile.bio || '';
        document.querySelector("header img").src = await getRoomProfilePictureUrl(roomId);
        document.querySelector("header").classList.remove("hidden")
        document.querySelector("header").setAttribute('aria-hidden', false);
      }

      document.querySelector('body header').addEventListener("long-press", () => {
        window.location.href = `/room/${roomId}/manage`;
      });

      const posts = await getCollectionData(`rooms/${roomId}/posts`).catch(console.error) || [];

      if (profile.initialized && !posts.length) {
        document.querySelector("main").innerHTML = `
          <article class="placeholder">
            <p>Zatím nejsou zde žádné příspěvky.</p>
          </article>
        `;
      } else if (posts.length) {
        document.querySelector("main").innerHTML = posts.map(renderPost).join('');
      }
    }


    async function handleFormSubmit(event) {

      event.preventDefault();
      postSubmitButton.setAttribute('disabled', true);
      const formData = new FormData(event.target);

      try {
        const { data: newPost } = await createPost({
          roomId,
          text: formData.get('text'),
        });
        document.querySelector('main').insertAdjacentHTML('beforeend', renderPost(newPost));
        postForm.reset();
        document.querySelector('main article.placeholder')?.remove();
      } catch (error) {
        console.error(error);
        alert(error.message);
      } finally {
        postSubmitButton.removeAttribute('disabled');
      }
    }

    function renderPost(post) {
      let markup = post.text;
      if (post.html) markup = post.html;
      if (!markup) return '';
      return `
        <article data-post-id="${post.id}">
          <pre>${markup}</pre>
        </article>
      `;
    }
  </script>
</body>

</html>